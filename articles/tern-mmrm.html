<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to tern.mmrm • tern.mmrm</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to tern.mmrm">
<meta property="og:description" content="tern.mmrm">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-125641273-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125641273-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tern.mmrm</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/tern-mmrm.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/insightsengineering/tern.mmrm" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to tern.mmrm</h1>
            
            <h4 data-toc-skip class="date">2022-03-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/insightsengineering/tern.mmrm/blob/HEAD/vignettes/tern-mmrm.Rmd" class="external-link"><code>vignettes/tern-mmrm.Rmd</code></a></small>
      <div class="hidden name"><code>tern-mmrm.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Mixed effect Models with Repeated Measures (MMRM) are often used as
the primary analysis of continuous longitudinal endpoints in clinical
trials. In this setting, an MMRM is a specific linear mixed effects
model that includes as fixed effects the variables: treatment arm,
categorical visit, treatment by visit interaction, and other covariates
for adjustment (e.g. age, gender). The covariance structure of the
residuals can take on different forms. Often, an unstructured
(i.e. saturated parametrization) covariance matrix is assumed which can
be represented by random effects in the mixed model.</p>
<p>All of this has been implemented in proprietary software such as SAS,
whose PROC MIXED routine is generally considered the gold standard for
mixed models. However, this does not allow the use of interactive web
applications to explore the clinical study data in a flexible way.
Therefore, we wanted to implement MMRM in R in a way which could easily
be embedded into a <code>shiny</code> application. See the <a href="https://insightsengineering.github.io/teal.modules.clinical/" class="external-link"><code>teal.modules.clinical</code>
package</a> for more details about using this code inside a
<code>shiny</code> application.</p>
</div>
<div class="section level2">
<h2 id="descriptive-statistics">Descriptive Statistics<a class="anchor" aria-label="anchor" href="#descriptive-statistics"></a>
</h2>
<p>Descriptive statistics for a relevant analysis population (e.g. those
patients with at least one post baseline visit) can be obtained by the
functions described in Section @ref(baseline-tables).</p>
</div>
<div class="section level2">
<h2 id="methodology">Methodology<a class="anchor" aria-label="anchor" href="#methodology"></a>
</h2>
<div class="section level3">
<h3 id="statistical-model">Statistical model<a class="anchor" aria-label="anchor" href="#statistical-model"></a>
</h3>
<p>Under the linear mixed model (LMM) framework, an outcome vector <span class="math inline">\({\bf Y}\)</span> is modeled as <span class="math display">\[\bf Y = X \boldsymbol \beta + Z b + {\boldsymbol
\varepsilon}\]</span> where <span class="math inline">\(\bf X\)</span>
is the matrix for fixed effects, <span class="math inline">\(\bf
Z\)</span> is the matrix for random effects, <span class="math inline">\(\mathbf b \sim N(0, \mathbf D(\boldsymbol
\theta))\)</span>, and <span class="math inline">\({\boldsymbol
\varepsilon} \sim N(0, \mathbf R(\boldsymbol \theta))\)</span>. Letting
<span class="math inline">\(\mathbf V = \mathbf Z \mathbf D \mathbf Z^T
+ \mathbf R\)</span>, the marginal and conditional models are then given
by <span class="math inline">\(\mathbf Y \sim N(\bf X \boldsymbol \beta,
V)\)</span> and <span class="math inline">\(\mathbf Y | \mathbf b \sim
N(\bf X \boldsymbol \beta + Z b, R)\)</span>, respectively.</p>
<p>An MMRM is a special case of a LMM such that <span class="math inline">\(\bf Y\)</span> is a collection of measurements
made on a set of individuals over time, i.e. <span class="math inline">\(\mathbf Y = ({\bf Y}_1^T, {\bf Y}_2^T,
...)^T\)</span> where <span class="math inline">\(\mathbf Y_i = \mathbf
X_i \boldsymbol \beta + \mathbf Z_i \mathbf b_i + {\boldsymbol
\varepsilon}_i\)</span>. In our context of clinical trials, individuals
are patients identified by their unique subject <code>id</code>,
measurements are of treatment <code>response</code>, and fixed effects
include treatment <code>arm</code>, categorical <code>visit</code>,
treatment by visit interaction, and potentially other
<code>covariates</code> (e.g. age, gender).</p>
</div>
<div class="section level3">
<h3 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h3>
<p>The parameters <span class="math inline">\(\boldsymbol
\beta\)</span>, <span class="math inline">\(\bf b\)</span>, and <span class="math inline">\(\boldsymbol \theta\)</span> can be estimated by
maximizing the penalized and restricted maximum likelihoods. The average
treatment response at each visit is often of particular interest.
However, simply comparing predicted marginal responses <span class="math inline">\(E(Y_{ij})\)</span> averaged across treatment x
visit groups will not account for potential imbalance in covariates.
(Imbalance may occur even in randomized trials due to patients dying or
dropping out over time.) For a more fair comparison,
<strong>least-squares (LS) mean</strong>:</p>
<ol style="list-style-type: decimal">
<li>establishes a reference grid where each cell represents a unique
combination of the factor (covariate) levels,</li>
<li>calculates the predicted marginal response for each cell, and
then</li>
<li>takes a weighted average of the predicted marginal responses.</li>
</ol>
<p>The following simple example illustrates the concept of LS means.
Suppose we have a longitudinal clinical trial where three factors are
considered: treatment (A and B), visit (1, 2, …), and gender (M and F).
The marginal predicted response (sample size) for each reference cell is
as follows.</p>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="center">A1</th>
<th align="center">B1</th>
<th align="center">…</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">M</td>
<td align="center">100 (20)</td>
<td align="center">90 (35)</td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left">F</td>
<td align="center">50 (30)</td>
<td align="center">40 (15)</td>
<td align="center"></td>
</tr>
</tbody>
</table>
<p>The average predicted responses for arms A and B at Visit 1 are <span class="math inline">\((100 \times 20 + 50 \times 30) / 50 = 70\)</span>
and <span class="math inline">\((90 \times 35 + 40 \times 15) / 50 =
75\)</span>, respectively. The overall mean is higher in arm B than in
arm A even though the mean is lower within each gender category. This
seeming contradiction is caused by the imbalance in the data. LS mean
calculates the weighted average across cells of the same treatment and
visit. In this example, this is equivalent to taking the weighted
average over each column. One may assign <em>equal</em> weights to each
cell, i.e. <span class="math inline">\(0.5 \times 100 + 0.5 \times 50 =
75\)</span> and <span class="math inline">\(0.5 \times 90 + 0.5 \times
40 = 65\)</span>. Alternatively, one may assign weights
<em>proportional</em> to the observed frequencies of the factor
combinations, i.e. <span class="math inline">\(0.55 \times 100 + 0.45
\times 50 = 77.5\)</span> and <span class="math inline">\(0.55 \times 90
+ 0.45 \times 40 = 67.5\)</span>. In both cases, the LS mean of response
is lower in arm B than in arm A.</p>
<p>LS means are calculated in <code>tern.mmrm</code> via the R package
<code>emmeans</code>. Users have the option to weigh marginal predicted
responses with either <code>equal</code> weights or
<code>proportional</code> weights. Note that for proportional weights,
the weights are calculated at each visit by taking into account the
observed frequencies of factor combinations at that time. Therefore,
even though covariate imbalance may vary over time, LS mean provides an
adjusted analysis of treatment response at all visits.</p>
</div>
<div class="section level3">
<h3 id="inference">Inference<a class="anchor" aria-label="anchor" href="#inference"></a>
</h3>
<p>Performing inference on estimated parameters (e.g. calculating
p-values) is less straightforward for MMRM. This is because the exact
null distributions for parameter effects are unknown. SAS addresses this
issue by utilizing Satterthwaite’s method to approximate the adjusted
degrees of freedom for <span class="math inline">\(F\)</span> and <span class="math inline">\(t\)</span> tests. <code>lme4</code> and
<code>lmerTest</code> have also implemented Satterthwaite’s method.
Thus, by relying on these two R packages, <code>tern.mmrm</code> is able
to replicate outputs from SAS.</p>
</div>
<div class="section level3">
<h3 id="covariance-structure">Covariance structure<a class="anchor" aria-label="anchor" href="#covariance-structure"></a>
</h3>
<p>Users of <code>tern.mmrm</code> have the following options for the
covariance structure <span class="math inline">\(\mathbf
V_i\)</span>:</p>
<ul>
<li>Unstructured: <span class="math display">\[V_{ij} =
\theta_{ij}\]</span>
</li>
<li>Random Intercept (i.e. compound symmetry with positive correlation):
<span class="math display">\[\mathbf Z_i = \mathbf 1,\ b_i \overset{iid}
\sim N(0, \theta),\ \varepsilon_{ij} \overset{iid}{\sim} N(0,
\sigma^2)\]</span> so that <span class="math display">\[\mathbf V_i =
\begin{bmatrix} \theta + \sigma^2 &amp; \theta &amp; \theta &amp; \cdots
\\ \theta &amp; \theta + \sigma^2 &amp; \theta &amp; \cdots \\ \theta
&amp; \theta &amp; \ddots &amp; \cdots \\ \theta &amp; \theta &amp;
\cdots &amp; \theta + \sigma^2 \end{bmatrix} \mbox{ and } corr(Y_{ij},
Y_{ik}) = \frac{\theta}{\theta + \sigma^2} \mbox{ for } j \neq
k\]</span>
</li>
<li>Random Slope: <span class="math display">\[\mathbf Z_i =
\begin{bmatrix} 1 &amp; t_{i1} \\ 1 &amp; t_{i2} \\ \vdots &amp; \vdots
\\ 1 &amp; t_{in_i} \end{bmatrix},\ b_i \overset{iid} \sim N \left (0,
\begin{bmatrix} \theta_{11} &amp; \theta_{12} \\ \theta_{12} &amp;
\theta_{22} \end{bmatrix} \right ),\ \varepsilon_{ij}
\overset{iid}{\sim} N(0, \sigma^2)\]</span>
</li>
<li>Random Quadratic: <span class="math display">\[\mathbf Z_i =
\begin{bmatrix} 1 &amp; t_{i1} &amp; t_{i1}^2 \\ 1 &amp; t_{i2} &amp;
t_{i2}^2 \\ \vdots &amp; \vdots \\ 1 &amp; t_{in_i} &amp; t_{in_i}^2
\end{bmatrix},\ b_i \overset{iid} \sim N \left (0, \begin{bmatrix}
\theta_{11} &amp; \theta_{12} &amp; \theta_{13} \\ \theta_{12} &amp;
\theta_{22} &amp; \theta_{23} \\ \theta_{13} &amp; \theta_{23} &amp;
\theta_{33} \end{bmatrix} \right ),\ \varepsilon_{ij}
\overset{iid}{\sim} N(0, \sigma^2)\]</span>
</li>
</ul>
<p>Note that some options available in SAS are not available in
<code>tern.mmrm</code>. This is because the <code>lme4</code> package
which <code>tern.mmrm</code> relies on has more restrictions regarding
the type of covariance structure that can be considered. Specifically,
<code>lme4</code> assumes <span class="math inline">\(\mathbf
D_i\)</span> is unstructured and <span class="math inline">\(\mathbf R_i
= \sigma^2 \mathbf I\)</span>, so that <span class="math inline">\(\mathbf V_i\)</span> is specified only through the
random design matrix <span class="math inline">\(\mathbf Z_i\)</span>.
This prevents us from implementing covariance structures that fall
outside of this scope, e.g. AR(1) where <span class="math inline">\((\mathbf V_i)_{jk} = \sigma^2
\rho^{|j-k|}\)</span> or Toeplitz where <span class="math inline">\((\mathbf V_i)_{jk}=\theta_{|j-k|}\)</span>. The
only exception is the unstructured model; although specifying <span class="math inline">\(\mathbf Z_i = \mathbf I_{n_i \times n_i}\)</span>,
unstructured <span class="math inline">\(\mathbf D_i\)</span>, and <span class="math inline">\(\mathbf R_i = \sigma^2 \mathbf I\)</span> results
in an over-parametrized model, <span class="math inline">\(\mathbf
V_i\)</span> as a whole is identifiable so that after suppressing some
error messages, we can in fact fit a MMRM with unstructured covariance
matrix (see next section).</p>
<p>Compared to <code>lme4</code>, the R package <code>nlme</code> can
consider more flexible covariance structures. However, we have chosen
not to use this package because it does not provide exact Satterthwaite
adjusted degrees of freedom and the available approximate degrees of
freedom can differ substantially.</p>
</div>
</div>
<div class="section level2">
<h2 id="model-fitting">Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h2>
<p>In this section, we illustrate how to fit a MMRM with
<code>tern.mmrm</code> and how to fit a MMRM manually in R. We then
compare with SAS to show that the results match.</p>
<div class="section level3">
<h3 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<p>Our example dataset consists of several variables: subject ID
(<code>USUBJID</code>), visit number (<code>AVISIT</code>), treatment
(<code>ARMCD</code> = TRT or PBO), 3-category race, sex, FEV1 at
baseline (%), and FEV1 at study visits (%). FEV1 (forced expired volume
in one second) is a measure of how quickly the lungs can be emptied. Low
levels of FEV1 may indicate chronic obstructive pulmonary disease
(COPD). The scientific question at hand is whether treatment leads to an
increase in FEV1 over time after adjusting for baseline covariates.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/insightsengineering/tern.mmrm" class="external-link">tern.mmrm</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: tern</span>
<span class="co">#&gt; Loading required package: rtables</span>
<span class="co">#&gt; Loading required package: magrittr</span>
<span class="co">#&gt; Loading required package: formatters</span>
<span class="co">#&gt; Registered S3 method overwritten by 'tern':</span>
<span class="co">#&gt;   method   from </span>
<span class="co">#&gt;   tidy.glm broom</span>
<span class="co">#&gt; Registered S3 methods overwritten by 'tern.mmrm':</span>
<span class="co">#&gt;   method         from</span>
<span class="co">#&gt;   as.rtable.mmrm tern</span>
<span class="co">#&gt;   tidy.mmrm      tern</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'tern.mmrm'</span>
<span class="co">#&gt; The following objects are masked from 'package:tern':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     fit_mmrm, g_mmrm_diagnostic, g_mmrm_lsmeans, h_mmrm_cov,</span>
<span class="co">#&gt;     h_mmrm_diagnostic, h_mmrm_fixed, s_mmrm_lsmeans,</span>
<span class="co">#&gt;     s_mmrm_lsmeans_single, summarize_lsmeans</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">mmrm_test_data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mmrm_test_data</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span>
<span class="co">#&gt;   USUBJID AVISIT ARMCD RACE                      SEX    FEV1_BL  FEV1</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>                     <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> PT1     VIS1   TRT   Black or African American Female    25.3  <span style="color: #BB0000;">NA</span>  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> PT1     VIS2   TRT   Black or African American Female    25.3  40.0</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> PT1     VIS3   TRT   Black or African American Female    25.3  <span style="color: #BB0000;">NA</span>  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> PT1     VIS4   TRT   Black or African American Female    25.3  20.5</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> PT2     VIS1   PBO   Asian                     Male      45.0  <span style="color: #BB0000;">NA</span>  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">6</span> PT2     VIS2   PBO   Asian                     Male      45.0  31.5</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-fitting-via-tern-mmrm">Model fitting via <code>tern.mmrm</code><a class="anchor" aria-label="anchor" href="#model-fitting-via-tern-mmrm"></a>
</h3>
<p>Fitting MMRM is easy in <code>tern.mmrm</code>. By default, the model
fitting function <code>fit_mmrm</code> assumes unstructured correlation
and proportional weights when calculating LS means.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mmrm_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_mmrm.html">fit_mmrm</a></span><span class="op">(</span>
  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    response <span class="op">=</span> <span class="st">"FEV1"</span>,
    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RACE"</span>, <span class="st">"SEX"</span>, <span class="st">"FEV1_BL"</span><span class="op">)</span>,
    id <span class="op">=</span> <span class="st">"USUBJID"</span>,
    arm <span class="op">=</span> <span class="st">"ARMCD"</span>,
    visit <span class="op">=</span> <span class="st">"AVISIT"</span>
  <span class="op">)</span>,
  data <span class="op">=</span> <span class="va">mmrm_test_data</span>,
  cor_struct <span class="op">=</span> <span class="st">"unstructured"</span>,
  weights_emmeans <span class="op">=</span> <span class="st">"proportional"</span>
<span class="op">)</span></code></pre></div>
<p>The resulting object consists among other things the estimated random
and fixed effects (<code>fit</code>), the estimated LS means for a
particular treatment at a particular visit (<code>lsmeans</code>), and
the difference in LS means at a particular visit
(<code>lsmeans$contrasts</code>). Based on the output, there is evidence
that supports treatment leading to an increase in FEV1 over placebo at
all study visits.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mmrm_results</span><span class="op">$</span><span class="va">lsmeans</span><span class="op">$</span><span class="va">contrasts</span>
<span class="co">#&gt;   AVISIT estimate        se       df lower_cl upper_cl   t_stat      p_value</span>
<span class="co">#&gt; 1   VIS1 3.983491 1.0453975 142.3217 1.916978 6.050004 3.810504 2.057335e-04</span>
<span class="co">#&gt; 2   VIS2 3.930770 0.8135014 142.2620 2.322657 5.538883 4.831916 3.458966e-06</span>
<span class="co">#&gt; 3   VIS3 2.983733 0.6656817 129.6022 1.666723 4.300743 4.482221 1.606826e-05</span>
<span class="co">#&gt; 4   VIS4 4.403899 1.6604869 132.8795 1.119493 7.688306 2.652174 8.971264e-03</span>
<span class="co">#&gt;   ARMCD relative_reduc</span>
<span class="co">#&gt; 1   TRT    -0.12102463</span>
<span class="co">#&gt; 2   TRT    -0.10425034</span>
<span class="co">#&gt; 3   TRT    -0.06893901</span>
<span class="co">#&gt; 4   TRT    -0.09154381</span></code></pre></div>
<p>Other correlation structures and weighting schemes can be considered.
For example, the following modified code fits a MMRM with random
intercept (compound symmetry with positive correlation) and equal
weights:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/fit_mmrm.html">fit_mmrm</a></span><span class="op">(</span>
  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    response <span class="op">=</span> <span class="st">"FEV1"</span>,
    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RACE"</span>, <span class="st">"SEX"</span>, <span class="st">"FEV1_BL"</span><span class="op">)</span>,
    id <span class="op">=</span> <span class="st">"USUBJID"</span>,
    arm <span class="op">=</span> <span class="st">"ARMCD"</span>,
    visit <span class="op">=</span> <span class="st">"AVISIT"</span>
  <span class="op">)</span>,
  data <span class="op">=</span> <span class="va">mmrm_test_data</span>,
  cor_struct <span class="op">=</span> <span class="st">"compound-symmetry"</span>,
  weights_emmeans <span class="op">=</span> <span class="st">"equal"</span>
<span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-fitting-manually-in-r">Model fitting manually in R<a class="anchor" aria-label="anchor" href="#model-fitting-manually-in-r"></a>
</h3>
<p>One can reproduce these results manually in R. For example, to fit
the unstructured model:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rvlenth/emmeans" class="external-link">emmeans</a></span><span class="op">)</span>

<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span>
  formula <span class="op">=</span> <span class="va">FEV1</span> <span class="op">~</span> <span class="va">RACE</span> <span class="op">+</span> <span class="va">SEX</span> <span class="op">+</span> <span class="va">FEV1_BL</span> <span class="op">+</span> <span class="va">ARMCD</span> <span class="op">*</span> <span class="va">AVISIT</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">AVISIT</span> <span class="op">|</span> <span class="va">USUBJID</span><span class="op">)</span>,
  data <span class="op">=</span> <span class="va">mmrm_test_data</span>,
  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html" class="external-link">lmerControl</a></span><span class="op">(</span>
    check.nobs.vs.nRE <span class="op">=</span> <span class="st">"ignore"</span>,
    optimizer <span class="op">=</span> <span class="st">"nloptwrap"</span>,
    optCtrl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"NLOPT_LN_BOBYQA"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="fu">emmeans</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span><span class="va">fit</span>, mode <span class="op">=</span> <span class="st">"satterthwaite"</span>, <span class="va">pairwise</span> <span class="op">~</span> <span class="va">ARMCD</span> <span class="op">|</span> <span class="va">AVISIT</span>, weights <span class="op">=</span> <span class="st">"proportional"</span><span class="op">)</span></code></pre></div>
<p>As mentioned in the previous section, although an unstructured model
is technically over-parametrized under <code>lmer</code>’s required
formulation, the marginal covariance as a whole is identifiable and we
can fit the model by including the argument
<code>check.nobs.vs.nRE = "ignore"</code> to suppress error
messages.</p>
<p>Compared to manual implementation, <code>tern.mmrm</code> users can
avoid specifying the <code>formula</code> as well as the non-linear
<code>optimizer</code> used to fit the MMRM. <code>tern.mmrm</code> has
a default optimizer which is in fact the same as the one shown here. If
the default fails to converge, it automatically attempts to use multiple
other optimizers, delivering results should there be a consensus.</p>
</div>
<div class="section level3">
<h3 id="model-fitting-via-sas">Model fitting via SAS<a class="anchor" aria-label="anchor" href="#model-fitting-via-sas"></a>
</h3>
For the unstructured model, the equivalent SAS code is given by
<div class="sas">
<pre class="sas"><code>proc import datafile="location_of_data.csv"
     out=dat
     dbms=csv
     replace;
     getnames=yes;
run;
     
proc mixed data= dat; 
       class ARMCD(ref="PBO") AVISIT(ref="VIS1") USUBJID SEX(ref="Male") RACE(ref="Asian");    
       Model FEV1 = ARMCD  RACE  SEX  FEV1_BL  AVISIT  ARMCD*AVISIT    / solution ddfm=satterthwaite;
       repeated AVISIT / type=UN subject=USUBJID;
       lsmeans ARMCD*AVISIT/pdiff obsmargins cl;
run;
</code></pre>
</div>
</div>
</div>
<div class="section level2">
<h2 id="diagnostics">Diagnostics<a class="anchor" aria-label="anchor" href="#diagnostics"></a>
</h2>
<div class="section level3">
<h3 id="model-fitting-1">Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting-1"></a>
</h3>
<p>A key part in the analysis of data is model selection, where often
the desire is to select a parsimonious model that adequately fits the
data. We provide four of the same information criteria as found in SAS
PROC MIXED.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mmrm_results</span><span class="op">$</span><span class="va">diagnostics</span></code></pre></div>
<p>Each criterion is specifically calculated as follows:</p>
<ol style="list-style-type: decimal">
<li>REML criterion: <span class="math inline">\(-2 l\)</span> where
<span class="math inline">\(l\)</span> is the REML log-likelihood. This
criterion has no penalty for complexity, so generally decreases as model
becomes more complex.</li>
<li>AIC: <span class="math inline">\(-2l + 2d\)</span> where <span class="math inline">\(d\)</span> is the number of covariance
parameters.</li>
<li>AICc: <span class="math inline">\(-2l + 2dn^*/(n^*-d-1)\)</span>
where <span class="math inline">\(n^*\)</span> is the number of
observations minus the number of fixed effects, or <span class="math inline">\(d + 2\)</span> if it is smaller than that. AICc is
a finite-sample corrected version of AIC.</li>
<li>BIC: <span class="math inline">\(-2l + d \log n\)</span> where <span class="math inline">\(n\)</span> is the number of subjects as opposed to
the number of observations.</li>
</ol>
<p>An objective approach to model selection is to minimize the AIC,
AICc, or BIC. For more details on these information criteria (including
references), see <a href="https://documentation.sas.com/?cdcId=statcdc&amp;cdcVersion=14.2&amp;docsetId=statug&amp;docsetTarget=statug_mixed_syntax01.htm&amp;locale=en#statug.mixed.procstmt_ic" class="external-link">SAS
Documentation</a>.</p>
</div>
<div class="section level3">
<h3 id="residual-analysis">Residual analysis<a class="anchor" aria-label="anchor" href="#residual-analysis"></a>
</h3>
<p>Another key part in the analysis of data is verifying model
assumptions. <code>g_mmrm_diagnostic(fit, type = ...)</code> provides
several handy residual plots, each of which is diagnostic for a
different aspect of MMRMs.</p>
<ul>
<li>Marginal fitted values (<span class="math inline">\(\mathbf X_i
\widehat {\boldsymbol \beta}\)</span>) vs. Marginal residuals (<span class="math inline">\(\mathbf Y_i - \mathbf X_i \widehat{\boldsymbol
\beta}\)</span>)
<ul>
<li>Argument: <code>type = "fit-residual"</code>
</li>
<li>Diagnostic for: homoskedasticity of marginal residuals</li>
</ul>
</li>
<li>QQ plot of standardized marginal residuals (<span class="math inline">\(\widehat{\mathbf V}_i^{-1/2} (\mathbf Y_i -
\mathbf X_i \widehat{\boldsymbol \beta})\)</span>)
<ul>
<li>Argument: <code>type = q-q-residual</code>
</li>
<li>Diagnostic for: normality of marginal residuals</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="outlook">Outlook<a class="anchor" aria-label="anchor" href="#outlook"></a>
</h2>
<p>We are actively looking to expand the capabilities of
<code>tern.mmrm</code>. Ongoing topics include:</p>
<ul>
<li>sensitivity of <code>lme4</code> to ordering of the dataset: in some
cases, <code>lme4</code> may not converge for a dataset but may converge
for the same data rearranged.</li>
<li>intermediate covariance structures: to increase complexity compared
to some simpler covariance structures, while having less model
parameters compared to an unstructured covariance matrix</li>
<li>additional model diagnostics: information criterion specifically for
evaluating fixed or random effects; residual plots to assess other model
assumptions</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by NEST, Roche, Daniel Sabanes Bove, Godwin Yung, Francois
Collin, Jana Stoilova.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
